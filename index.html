<!DOCTYPE html>
<html>
  <head>
    <style>
      html, head { width: 100%; height: 100%; overflow: hidden; }
    </style>
  </head>
  <body>
    <canvas id="lienzo"></canvas>
    <script src="clases/Nave.js"></script>
    <script src="clases/Proyectil.js"></script>
       <script src="funciones/funciones.js"></script>
    <script src="funciones/controles.js"></script>
    <script src="funciones/colisiones.js"></script>
    <script>
      const lienzo = document.getElementById("lienzo");
      const contexto = lienzo.getContext("2d");
      lienzo.width = window.innerWidth;
      lienzo.height = window.innerHeight;
        
      const jugador1 = new Nave(getRandomHexColor());
      jugador1.dibuja();

      var gira1 = 0;
      var avanza1 = false;
      var disparar1 = false;

      // WebSocket connection
      const socket = new WebSocket("ws://192.168.1.38:3000");

      socket.addEventListener("open", (event) => {
        console.log("WebSocket connection opened");
      });

      socket.addEventListener("error", (event) => {
        console.error("WebSocket error:", event);
      });

      socket.addEventListener("message", (event) => {
        // Handle incoming WebSocket messages here
        const data = JSON.parse(event.data);
        // Process data from the server
        let  datos = JSON.parse(event.data)
        //console.log(datos);
          //contexto.clearRect(0, 0, window.innerWidth, window.innerHeight)
          contexto.fillStyle = "rgba(255,255,255,0.1)"
          contexto.fillRect(0, 0, window.innerWidth, window.innerHeight)
          jugador1.dibuja();
          if(datos.position.x != jugador1.posx ){
             
              
                contexto.save();
                contexto.translate(datos.position.x, datos.position.y);
              contexto.rotate(datos.rotation);
          contexto.fillStyle = datos.color;
          contexto.beginPath();

          const x1 = 0;
          const y1 = -10;
          const x2 = -5;
          const y2 = 5;
          const x3 = 5;
          const y3 = 5;

          contexto.moveTo(x1, y1);
          contexto.lineTo(x2, y2);
          contexto.lineTo(x3, y3);
          contexto.closePath();
          contexto.fill();
          contexto.fillStyle = "white";
          contexto.beginPath();
          contexto.arc(0, 0, 2, 0, Math.PI * 2, true);
          contexto.closePath();
          contexto.fill();

          contexto.restore();
              
              
              
              //console.log(datos.projectiles)
              for(let i = 0;i<datos.projectiles.length;i++){
                  //console.log("bala")
                  contexto.fillStyle = datos.color
                  contexto.beginPath()
                  contexto.arc(
                      datos.projectiles[i].posx,
                      datos.projectiles[i].posy,
                      3,0,Math.PI*2,true)
                contexto.fill()
                   if (checkPlayerProjectileCollision(jugador1, datos.projectiles[i]) && jugador1.color != datos.projectiles[i].color) {
                    // Collision detected, handle it here
                        console.log("Collision detected between player and projectile");
                           window.location = window.location
                  }
              }
        }
          
          
      });
window.addEventListener("keydown", onKeyDown);
        window.addEventListener("keyup", onKeyUp);
        
      setTimeout(function () {
        
        let temporizador = setTimeout(bucle, 30);
        function bucle() {
          jugador1.gira(gira1);
          if (avanza1) {
            jugador1.avanza();
          }
          jugador1.applyInertia();
           
            
          
          if (disparar1) {
            jugador1.fireProjectile();
          }
          jugador1.dibujaProyectiles();

          // Send player's position, rotation, and projectile positions to the server
          const playerData = {
            position: jugador1.getPosition(),
            rotation: jugador1.getRotation(),
            projectiles: jugador1.getProjectiles(),
              color: jugador1.getColor(),
          };
           socket.send(JSON.stringify(playerData));

          clearTimeout(temporizador);
          temporizador = setTimeout(bucle, 10);
        }
      },1000)
        
        
    </script>
  </body>
</html>
